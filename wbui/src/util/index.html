<html>
<head>
  <title>WB UTILITY</title>
  <link rel="stylesheet" href="style.css" type='text/css' />
  <script type="text/javascript" src="http://www.google.com/jsapi"></script>
  <script type="text/javascript">google.load("jquery", "1.4.2");</script>
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.1/jquery-ui.min.js"></script>
  <script type="text/javascript">google.load("jqueryui", "1.8.1");</script>
  <script language="JavaScript"><!--
	$(function(){
	  $("#tabs").tabs();
	  $("#take_screenshot").click(function() {
	    $("#screenshot").empty();
	    $("#screenshot").append("<img src='screenshot.png?" + new Date().getTime() + "'/>");
	  });
	  $("#issue_csr").click(function() {
	    var serial = $("#serial").val(); 
	  	if (serial == "") {
		  $("#csr").empty();
	  	  $("#csr").append("<br/><font color='crimson'>シリアル番号（通常、英数字8桁）を入力してください。</font>")
	  	  return;
	  	}
	    $.get("csr.txt", {"serial":serial}, function(data) {
		  $("#csr").empty();
		  $("#csr").append("<br/>下記のCSRをコピーして開発元へお送り下さい。折り返しクライアント証明書が発行されます。<br/><pre>" + data + "</pre>")
		});
	  });
	  $("#put_crt").click(function() {
	    $.post("crt", {"crt":$("#crt_area").val()}, function(data) {
		  if (data.substr(0,2) == "OK") {
		    $("#crt_msg").html("クライアント証明書がインストールされました。WBUIの再起動（「タイトルへ戻る」）をした後で、「設定」メニューから中央サーバへの接続を行って下さい。");
		  } else {
		    $("#crt_msg").html("<font color='crimson'>証明書が不正です(" + data + ")</font>");
		  }
		});
	  });
	  $("#export_key").click(function() {
	  	var passphrase = $("#encryption_passphrase").val();
	  	if (passphrase.indexOf("'", 0) >= 0) {
		  	  $("#key").empty();
			  $("#key").append("<br/><font color='crimson'>申し訳ありませんが、暗号キーにシングルクォートは使えません。</font>")
			  return;
	  	}
	  	$.get("key.txt", {"passphrase":passphrase}, function(data) {
	  	  $("#key").empty();
		  $("#key").append("<br/>下記の秘密鍵をコピーして保存して下さい。暗号化をした場合は、キーを忘れないようにしてください。<br/><pre>" + data + "</pre>")
	  	});
	  });
	  $("#import_key").click(function() {
	  	$.post("key", {"key":$("#key_area").val(),"passphrase":$("#decryption_passphrase").val(),"override":$("#override_key").attr('checked')}, function(data) {
	  	  if (data.substr(0,2) == "OK") {
	  	    $("#key_msg").html("秘密鍵がインポートされました。");
	  	  } else {
	  	  	$("#key_msg").html("<font color='crimson'>秘密鍵のインポートに失敗しました。既に存在する秘密鍵を強制的に上書きするには、「秘密鍵が既に存在している場合は上書きする」をチェックして下さい。(" + data + ")</font>");
	  	  }
	  	});
	  });
	  $("#put_ak").click(function() {
	    $.post("authorized_keys", {"ak":$("#ak").val()}, function(data) {
		  if (data.substr(0,2) == "OK") {
		    $("#ak_msg").html("SSH公開鍵が更新されました。");
		  } else {
		    $("#ak_msg").html("<font color='crimson'>エラーが発生しました(" + data + ")</font>");
		  }
		});
	  });

	  $.get("crt.txt", {}, function(data) {
	    $("#crt_area").text(data);
	  });
	  $.get("authorized_keys.txt", {} ,function(data) {
		  $("#ak").text(data);
	  });
	});
//--></script>
</head>
<body>
<img src="title.png"/>
<h1>WBユーティリティ</h1>
<div id="tabs">
	<ul>
		<li><a href="#tabs-1">スクリーンショット</a></li>
		<li><a href="#tabs-2">証明書の管理</a></li>
		<li><a href="#tabs-3">秘密鍵の管理</a></li>
		<li><a href="#tabs-4">SSH公開鍵</a></li>
	</ul>
	<div id="tabs-1">
		<h2>スクリーンショット</h2>
		<button id="take_screenshot" type="button">撮る</button><br/>
		<div id="screenshot"></div>
	</div>
	<div id="tabs-2">
		<h2>CSRの発行</h2>
		開発元から発行されたシリアル番号:<input type="text" id="serial"/> <button id="issue_csr" type="button">CSRを発行する</button><br/>
		※シリアル番号は大文字小文字を区別します<br/>
		<div id="csr"></div>
		<h2>クライアント証明書のインストール</h2>
		<div id="crt">
		<textarea id="crt_area" cols="78" rows="10"></textarea><br/>
		ここに開発元から発行されたクライアント証明書(-----BEGIN CERTIFICATE-----で始まり -----END CERTIFICATE-----で終わるテキスト)を貼り付けてください。<button id="put_crt" type="button">証明書を設置</button>
		</div>
		<span id="crt_msg"></span>
	</div>
	<div id="tabs-3">
		<h2>秘密鍵のエクスポート</h2>
		秘密鍵の暗号化に使用するキー（空欄にすると暗号化されません）:
		<input type="password" id="encryption_passphrase"/> <button id="export_key" type="button">秘密鍵をエクスポートする</button><br/>
		<div id="key"></div>
		<h2>秘密鍵のインポート</h2>
		<textarea id="key_area" cols="78" rows="10"></textarea><br/>
		ここに他のホストからエクスポートされた秘密鍵(-----BEGIN RSA PRIVATE KEY-----で始まり -----END RSA PRIVATE KEY-----で終わるテキスト)を貼り付けてください。<br/>
		<input type="checkbox" id="override_key"/>秘密鍵が既に存在している場合は上書きする<br/>
		秘密鍵を暗号化する際に使用したキー:<input type="password" id="decryption_passphrase"/> <button id="import_key" type="button">秘密鍵をインポートする</button><br/>
		<span id="key_msg"></span>
	</div>
	<div id="tabs-4">
		<h2>SSH公開鍵の編集</h2>
		<div>
		<textarea id="ak" cols="78" rows="10"></textarea><br/>
		ここで ~root/.ssh/authorized_keysを編集できます。ここに設置された公開鍵に対応する秘密鍵を所有していればパスワードを使わず root権限でシステムにログイン出来ます。鍵ファイルの管理には十分ご注意下さい。<button id="put_ak" type="button">上記内容に更新</button>
		</div>
		<span id="ak_msg"></span>
	</div>
</div>
</body>
</html>
