set gfxmode='640x480x32'
set gfxpayload='keep'
insmod gfxterm
insmod vbe
terminal_output gfxterm

source /boot/grub/walbrix.cfg
source (loop)/grubvars.cfg

if [ -z "$WALBRIX_LOCALE" ]; then
	set WALBRIX_LOCALE=ja_JP
fi

set LINUX_COMMON_ARGS="walbrix.boot=$WALBRIX_BOOT walbrix.locale=$WALBRIX_LOCALE scandelay edd=off"
set LINUX_SPLASH_ARGS="splash=silent,theme:wb console=tty1 quiet"
set LINUX_NOMODESET_ARGS="nomodeset i915.modeset=0 nouveau.modeset=0"

menuentry 'Install Walbrix '$WALBRIX_VERSION {
	echo 'Loading kernel...'
	linux (loop)/i686/boot/kernel $LINUX_COMMON_ARGS $LINUX_SPLASH_ARGS $LINUX_NOMODESET_ARGS softlevel=install
	echo 'Loading initramfs...'
	initrd (loop)/i686/boot/initramfs
}

if cpuid -l; then

menuentry 'Rescue 64bit' {
	echo 'Loading kernel...'
	linux (loop)/x86_64/boot/kernel $LINUX_COMMON_ARGS $LINUX_NOMODESET_ARGS softlevel=rescue
	echo 'Loading initramfs...'
	initrd (loop)/x86_64/boot/initramfs
}

fi

menuentry 'Rescue 32bit' {
	echo 'Loading kernel...'
	linux (loop)/i686/boot/kernel $LINUX_COMMON_ARGS $LINUX_NOMODESET_ARGS softlevel=rescue
	echo 'Loading initramfs...'
	initrd (loop)/i686/boot/initramfs
}

if [ "${grub_platform}" = "pc" ]; then
	menuentry 'memtest86+' {
		linux16 (loop)/i686/boot/memtest86plus/memtest
	}
fi
